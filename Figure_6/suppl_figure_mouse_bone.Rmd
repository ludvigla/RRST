---
title: "Suppl figure mouse bone"
author: "Ludvig Larsson"
date: '2022-05-23'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load libraries

```{r eval=FALSE}

library(STutility)
library(ggplot2)
library(ggpubr)

```

Assemble spaceranger output files and merge curated meta data

```{r eval=FALSE}

# Mouse brain
samples <- Sys.glob(paths = "../../spaceranger_output/mousebone/*/filtered_feature_bc_matrix.h5")
imgs <- Sys.glob(paths = "../../spaceranger_output/mousebone/*/spatial/tissue_hires_image.png")
spotfiles <- Sys.glob(paths = "../../spaceranger_output/mousebone/*/spatial/tissue_positions_list.csv")
json <- Sys.glob(paths = "../../spaceranger_output/mousebone/*/spatial/scalefactors_json.json")

infoTable <- data.frame(samples, imgs, spotfiles, json)
infoTable <- cbind(infoTable, arrayID = do.call(rbind, strsplit(infoTable$samples, "/"))[, 5])

curated_metadata <- openxlsx::read.xlsx("../../sheets/curated_RNA_rescue_sample_metadata.xlsx", sheet = 3)
curated_metadata <- setNames(curated_metadata, nm = c("storage_time", "seq_date", "include", "RNA_rescue",
                                                       "project", "experimenter", "processer", "comments",
                                                       "ID", "paper_id", "RIN", "DV200", "protocol", "source", "arrayID", "spots_under_tissue",
                                                       "genes_detected", "fraction_spots_under_tissue",
                                                       "median_genes_per_spot", "median_UMIs_per_spot", 
                                                       "saturation", "reads_mapped_to_probe_set",
                                                       "reads_mapped_confidently_to_probe_set",
                                                       "reads_mapped_confidently_to_filtered_probe_set",
                                                       "reads_mapped_to_genome",
                                                       "reads_mapped_confidently_to_genome",
                                                       "number_of_panel_genes"))

infoTable <- merge(infoTable, curated_metadata, by = "arrayID")

```

Load data into a Seurat object

```{r eval=FALSE}

BN <- InputFromTable(infoTable[c(1, 3, 4, 2, 5, 6), ])

```

```{r eval=FALSE}

ST.FeaturePlot(BN, features = "nFeature_RNA", ncol = 3)

```

Load images

```{r eval=FALSE}

BN <- LoadImages(BN, time.resolve = FALSE, xdim = 1e3)

```

Add empty masks for downstream processing of HE images

```{r eval=FALSE}

# Prepare data for rigid transformation
st.object <- GetStaffli(BN)
msks <- lapply(st.object@rasterlists$raw, function(im) {
  as.raster(matrix(data = 1, ncol = ncol(im), nrow = nrow(im)))
})
st.object@rasterlists$masked <- st.object@rasterlists$raw
st.object@rasterlists$masked.masks <- msks
BN@tools$Staffli <- st.object

```

Add a new metadata column with a combined protocol and lung ID label

```{r eval=FALSE}

BN$protocol_smpl <- gsub(pattern = " ", replacement = "_", paste0(BN$protocol, "_ID: ", BN$paper_id))
ST.FeaturePlot(BN, features = "nFeature_RNA", ncol = 3, label.by = "protocol_smpl")

```

## QC
***

The standard Visium data sets have reduced numbers of unique genes compared to the data generated by RRST.

```{r eval=FALSE}

VlnPlot(BN, features = "nFeature_RNA", group.by = "arrayID", split.by = "protocol")

```

Violin QC plot

```{r eval=FALSE}

plot_QC <- BN[[]] %>% ggplot(aes(arrayID, nFeature_RNA, fill = protocol)) +
  geom_violin(scale = "width") +
  facet_grid(~ID, scales = "free", 
             labeller = labeller(protocol = c("RNA rescue" = "RRST", "standard" = "standard"))) +
  labs(fill = "", x = "Unique genes", y = "Count") +
  theme_minimal() +
  theme(strip.background = element_rect(fill = "#A3B3C3"), strip.text = element_text(face = "bold", colour = "white")) +
  scale_fill_brewer(palette = "Pastel2") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(x = "", y = "")

```

Select bone/cartilage spots

```{r eval=FALSE}

BN <- ManualAnnotation(BN)
#saveRDS(object = BN[[]], file = "bone_selection")

```

Apply transformations

```{r eval=FALSE}

# Warp transform
# BN <- WarpImages(BN, verbose = TRUE, transforms = list( "3" = list(angle = -110), "6" = list(angle = -50)))

```

```{r}

BN <- WarpImages(BN, transforms = list("1" = list(angle = -50), "3" = list(angle = -110), "4" = list(angle = 130), "6" = list(angle = -50)))

# Export H&E
for (i in c("1", "4")) {
  im <- GetStaffli(BN)@rasterlists$processed[[i]]
  dims <- GetStaffli(BN)@dims[[i]]
  jpeg(filename = paste0(i, "_processed.jpeg"), width = dims$width, dims$height)
  par(mar=c(0,0,0,0))
  plot(im)
  dev.off()
}

```


```{r eval=FALSE}

gg <- BN[[]] %>% 
  mutate(labels = case_when(labels == "cartilage_bone" ~ "cartilage/bone",
                            labels == "Default" ~ "surrounding tissue"),
         protocol = case_when(protocol == "RNA rescue" ~ "RRST", TRUE ~ protocol),
         ID = factor(ID, levels = c("P4T", "P11T")))

plot_UG <- ggplot() +
    geom_violin(data = gg, aes(arrayID, nFeature_RNA, fill = protocol), scale = "width") +
    geom_hline(data = gg %>% group_by(labels, ID, protocol) %>% summarize(Median = median(nFeature_RNA)), aes(yintercept = Median), 
               linetype = "longdash", color = "#3A3B3C") +
    geom_label(data = gg %>% group_by(labels, ID, protocol) %>% summarize(Median = round(median(nFeature_RNA))), 
               aes(x = "A", y = Median, label = Median)) +
    facet_grid(labels~ID, scales = "free") +
    labs(fill = "", x = "Unique genes", y = "Count") +
    theme_minimal() +
    theme(strip.background = element_rect(fill = "#3A3B3C"), strip.text = element_text(face = "bold", colour = "white", size = 12)) +
    scale_fill_brewer(palette = "Pastel2") +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 12, color = "black"), legend.position = "none", 
          axis.text.y = element_text(size = 12, color = "black")) +
    labs(x = "", y = "") +
    scale_x_discrete(labels = c("", "rep1", "rep1", "rep2"))

plot_UMI <- ggplot() +
    geom_violin(data = gg, aes(arrayID, nCount_RNA, fill = protocol), scale = "width") +
    geom_hline(data = gg %>% group_by(labels, ID, protocol) %>% summarize(Median = median(nCount_RNA)), aes(yintercept = Median), 
               linetype = "longdash", color = "#3A3B3C") +
    geom_label(data = gg %>% group_by(labels, ID, protocol) %>% summarize(Median = round(median(nCount_RNA))), 
               aes(x = "A", y = Median, label = Median)) +
    scale_y_log10() +
    facet_grid(labels~ID, scales = "free") +
    labs(fill = "", x = "Unique genes", y = "Count") +
    theme_minimal() +
    theme(strip.background = element_rect(fill = "#3A3B3C"), strip.text = element_text(face = "bold", colour = "white", size = 12)) +
    scale_fill_brewer(palette = "Pastel2") +
    theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 12, color = "black"), legend.position = "none", 
          axis.text.y = element_text(size = 12, color = "black")) +
    labs(x = "", y = "") +
    scale_x_discrete(labels = c("", "rep1", "rep1", "rep2"))

```

Plot selection

```{r}

limits_list <- list("1" = c(x_start = 540, y_start = 490, x_end = 540 + 1150, y_end = 490 + 1150),
                    "3" = c(x_start = 624, y_start = 621, x_end = 624 + 1150, y_end = 621 + 1150), 
                    "4" = c(x_start = 380, y_start = 255, x_end = 380 + 1150, y_end = 255 + 1150), 
                    "6" = c(x_start = 480, y_start = 330, x_end = 480 + 1100, y_end = 330 + 1100))
gg <- cbind(BN[[]], GetStaffli(BN)@meta.data)
gg$UMIs <- log10(gg$nCount_RNA)
UG_limits <- gg %>%
    summarize(max = max(nFeature_RNA))
UG_limits <- setNames(UG_limits$max, nm = UG_limits$variable)
UMI_limits <- gg %>%
    summarize(max = max(UMIs))
UMI_limits <- setNames(UMI_limits$max, nm = UMI_limits$variable)



# Create UG spatial plot
UG_plots <- setNames(lapply(c("1", "3", "4", "6"), function(i) {
  
  # Get meta data and coordinates
  gg <- cbind(BN[[]], GetStaffli(BN)@meta.data)
  gg <- subset(gg, sample == i)
  dims <- GetStaffli(BN)@dims[[i]]
  
  # Get H&E image
  im <- GetStaffli(BN)@rasterlists$processed[[paste0(i)]]
  sf <- nrow(im)/dims$height
  im <- im[limits_list[[i]]["y_start"]:limits_list[[i]]["y_end"]*sf, limits_list[[i]]["x_start"]:limits_list[[i]]["x_end"]*sf]
  g <- grid::rasterGrob(im, width = unit(1, "npc"), height = unit(1, "npc"), interpolate = TRUE)
  
  # Create plots
  p <- ggplot() +
    annotation_custom(g, -Inf, Inf, -Inf, Inf) +
    geom_point(data = gg, aes(warped_x, dims$height - warped_y, fill = nFeature_RNA), 
               size = 1.2, shape = 21, stroke = 0) +
    theme_void() +
    scale_x_continuous(expand = c(0, 0), limits = c(limits_list[[i]]["x_start"], limits_list[[i]]["x_end"])) +
    scale_y_continuous(expand = c(0, 0), limits = c(dims$height - limits_list[[i]]["y_end"], dims$height - limits_list[[i]]["y_start"])) +
    labs(fill = "") +
    guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5)) +
    scale_fill_gradientn(colours = RColorBrewer::brewer.pal(n = 11, name = "Spectral") %>% rev(), 
                         limits = c(0, UG_limits)) 
  if (i == "1") {
    p <- p + theme(legend.position = "top", plot.margin = margin(r = 3, b = 3),
                   legend.key.height = unit(0.4, 'cm'),
                   legend.key.width = unit(1, 'cm'))
  } else {
    p <- p + theme(legend.position = "none")
  }

  p <- ggrastr::rasterize(p, layers = "Point", dpi = 300)
  return(p)
}), nm = c("1", "3", "4", "6"))


# Create spatial UMI plots
UMI_plots <- setNames(lapply(c("1", "3", "4", "6"), function(i) {
  
  # Get meta data and coordinates
  gg <- cbind(BN[[]], GetStaffli(BN)@meta.data)
  gg <- subset(gg, sample == i)
  gg$UMIs <- log10(gg$nCount_RNA)
  dims <- GetStaffli(BN)@dims[[i]]
  
  
  # Get H&E image
  im <- GetStaffli(BN)@rasterlists$processed[[paste0(i)]]
  sf <- nrow(im)/dims$height
  im <- im[limits_list[[i]]["y_start"]:limits_list[[i]]["y_end"]*sf, limits_list[[i]]["x_start"]:limits_list[[i]]["x_end"]*sf]
  g <- grid::rasterGrob(im, width = unit(1, "npc"), height = unit(1, "npc"), interpolate = TRUE)
  
  # Create plots
  p <- ggplot() +
    annotation_custom(g, -Inf, Inf, -Inf, Inf) +
    geom_point(data = gg, aes(warped_x, dims$height - warped_y, fill = UMIs), 
               size = 1.2, shape = 21, stroke = 0) +
    theme_void() +
    scale_x_continuous(expand = c(0, 0), limits = c(limits_list[[i]]["x_start"], limits_list[[i]]["x_end"])) +
    scale_y_continuous(expand = c(0, 0), limits = c(dims$height - limits_list[[i]]["y_end"], dims$height - limits_list[[i]]["y_start"])) +
    labs(fill = "") +
    guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5)) +
    scale_fill_gradientn(colours = RColorBrewer::brewer.pal(n = 11, name = "Spectral") %>% rev(), 
                         limits = c(0, UMI_limits), labels= c(1, 10, 100, 1000, 10000)) 
  if (i == "1") {
    p <- p + theme(legend.position = "top", plot.margin = margin(r = 3, b = 3),
                   legend.key.height = unit(0.4, 'cm'),
                   legend.key.width = unit(1, 'cm'))
  } else {
    p <- p + theme(legend.position = "none")
  }

  p <- ggrastr::rasterize(p, layers = "Point", dpi = 300)
  return(p)
}), nm = c("1", "3", "4", "6"))


# Plot annotations
bone_plots <- setNames(lapply(c("1", "3", "4", "6"), function(i) {
  
  # Get meta data and coordinates
  gg <- cbind(BN[[]], GetStaffli(BN)@meta.data)
  gg <- subset(gg, sample == i)
  gg$UMIs <- log10(gg$nCount_RNA)
  dims <- GetStaffli(BN)@dims[[i]]
  
  
  # Get H&E image
  im <- GetStaffli(BN)@rasterlists$processed[[paste0(i)]]
  sf <- nrow(im)/dims$height
  im <- im[limits_list[[i]]["y_start"]:limits_list[[i]]["y_end"]*sf, limits_list[[i]]["x_start"]:limits_list[[i]]["x_end"]*sf]
  g <- grid::rasterGrob(im, width = unit(1, "npc"), height = unit(1, "npc"), interpolate = TRUE)
  
  # Create plots
  p <- ggplot() +
    annotation_custom(g, -Inf, Inf, -Inf, Inf) +
    geom_point(data = gg %>% mutate(labels = case_when(labels == "cartilage_bone" ~ "cartilage/bone",
                                                       TRUE ~ "surrounding tissue")), aes(warped_x, dims$height - warped_y, fill = labels), 
               size = 1.2, shape = 21, stroke = 0) +
    theme_void() +
    scale_x_continuous(expand = c(0, 0), limits = c(limits_list[[i]]["x_start"], limits_list[[i]]["x_end"])) +
    scale_y_continuous(expand = c(0, 0), limits = c(dims$height - limits_list[[i]]["y_end"], dims$height - limits_list[[i]]["y_start"])) +
    labs(fill = "") +
    guides(fill = guide_legend(title.position = "top", title.hjust = 0.5, override.aes = list(size = 7))) +
    scale_fill_manual(values = c("surrounding tissue" = "lightgray", "cartilage/bone" = "orange"))
  
  if (i == "1") {
    p <- p + theme(legend.position = "top", plot.margin = margin(r = 3, b = 3),
                   legend.key.height = unit(0.4, 'cm'),
                   legend.key.width = unit(1, 'cm'))
  } else {
    p <- p + theme(legend.position = "none")
  }

  p <- ggrastr::rasterize(p, layers = "Point", dpi = 300)
  return(p)
}), nm = c("1", "3", "4", "6"))

# Create H&E plots
HE_plots <- setNames(lapply(c("1", "3", "4", "6"), function(i) {
  
  # Get H&E image
  im <- GetStaffli(BN)@rasterlists$processed[[paste0(i)]]
  sf <- nrow(im)/dims$height
  im <- im[limits_list[[i]]["y_start"]:limits_list[[i]]["y_end"]*sf, limits_list[[i]]["x_start"]:limits_list[[i]]["x_end"]*sf]
  g <- grid::rasterGrob(im, width = unit(1, "npc"), height = unit(1, "npc"), interpolate = TRUE)
  
  # Create plots
  p <- ggplot() +
    annotation_custom(g, -Inf, Inf, -Inf, Inf) 
  return(p)
}), nm = c("1", "3", "4", "6"))

```


Suppl figure patchwork

```{r}

design = c(
  area(1, 1, 2, 2),
  area(1, 3, 2, 4),
  
  area(3, 1, 3, 1), 
  area(3, 2, 3, 2), 
  area(3, 3, 3, 3), 
  area(3, 4, 3, 4),
  
  area(4, 1, 4, 1), 
  area(4, 2, 4, 2), 
  area(4, 3, 4, 3), 
  area(4, 4, 4, 4),
  
  area(5, 1, 5, 1), 
  area(5, 2, 5, 2),
  area(5, 3, 5, 3), 
  area(5, 4, 5, 4),
  
  area(6, 1, 6, 1), 
  area(6, 2, 6, 2),
  area(6, 3, 6, 3), 
  area(6, 4, 6, 4))

spatial_QC <- 
  plot_UG +
  plot_UMI +
  HE_plots$`1` +
  HE_plots$`3` +
  HE_plots$`4` +
  HE_plots$`6` +
  bone_plots$`1` + 
  bone_plots$`3` + 
  bone_plots$`4` + 
  bone_plots$`6` + 
  UG_plots$`1` + 
  UG_plots$`3` + 
  UG_plots$`4` + 
  UG_plots$`6` + 
  UMI_plots$`1` + 
  UMI_plots$`3` + 
  UMI_plots$`4` + 
  UMI_plots$`6` + 
  plot_layout(design = design, heights = c(0.8, 0.8, 1, 1, 1, 1))

pdf(file = "../Suppl_figures/Suppl_Figure_mBone/patchwork_mBone_suppl.pdf", width = 12, height = 16)
print(spatial_QC)
dev.off()

```



# date
***

```{r}
date()
```

# Session
***

```{r}
devtools::session_info()
```