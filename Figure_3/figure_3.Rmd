---
title: "Figure 3"
author: "Ludvig Larsson"
date: '2022-05-23'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load libraries

```{r eval=FALSE}

library(STutility)
library(ggplot2)
library(ggpubr)

```

Assemble spaceranger output files and merge curated meta data

```{r eval=FALSE}

# Mouse brain
samples <- Sys.glob(paths = "../../spaceranger_output/colon/*/filtered_feature_bc_matrix.h5")
imgs <- Sys.glob(paths = "../../spaceranger_output/colon/*/spatial/tissue_hires_image.png")
spotfiles <- Sys.glob(paths = "../../spaceranger_output/colon/*/spatial/tissue_positions_list.csv")
json <- Sys.glob(paths = "../../spaceranger_output/colon/*/spatial/scalefactors_json.json")

infoTable <- data.frame(samples, imgs, spotfiles, json)
infoTable <- cbind(infoTable, arrayID = do.call(rbind, strsplit(infoTable$samples, "/"))[, 5])

curated_metadata <- openxlsx::read.xlsx("../../sheets/curated_RNA_rescue_sample_metadata.xlsx", sheet = 3)
curated_metadata <- setNames(curated_metadata, nm = c("storage_time", "seq_date", "include", "RNA_rescue",
                                                       "project", "experimenter", "processer", "comments",
                                                       "ID", "paper_id", "protocol", "source", "arrayID", "spots_under_tissue",
                                                       "genes_detected", "fraction_spots_under_tissue",
                                                       "median_genes_per_spot", "median_UMIs_per_spot", 
                                                       "saturation", "reads_mapped_to_probe_set",
                                                       "reads_mapped_confidently_to_probe_set",
                                                       "reads_mapped_confidently_to_filtered_probe_set",
                                                       "reads_mapped_to_genome",
                                                       "reads_mapped_confidently_to_genome",
                                                       "number_of_panel_genes"))

infoTable <- merge(infoTable, curated_metadata, by = "arrayID")

```

Load data into a Seurat object


```{r eval=FALSE}

CLN <- InputFromTable(infoTable[c(5:6, 2, 4, 1, 3), ])

```

```{r eval=FALSE, fig.width=10, fig.height=6}

CLN$protocol_array <- paste0(CLN$protocol, " : ", CLN$arrayID)
ST.FeaturePlot(CLN, features = "nFeature_RNA", ncol = 3, label.by = "protocol_array", show.sb = FALSE, pt.size = 1.5)

```

Load images

```{r eval=FALSE}

CLN <- LoadImages(CLN, time.resolve = FALSE, xdim = 1e3)

```

Add empty masks for downstream processing of HE images

```{r eval=FALSE}

# Prepare data for rigid transformation
st.object <- GetStaffli(CLN)
msks <- lapply(st.object@rasterlists$raw, function(im) {
  as.raster(matrix(data = 1, ncol = ncol(im), nrow = nrow(im)))
})
st.object@rasterlists$masked <- st.object@rasterlists$raw
st.object@rasterlists$masked.masks <- msks
CLN@tools$Staffli <- st.object

```

Apply transformations

```{r eval=FALSE}

# Warp transform
CLN <- WarpImages(CLN, verbose = TRUE, transforms = list("1" = list(angle = -90), "2" = list(angle = -90, mirror.x = TRUE), "4" = list(angle = -90), "5" = list(angle = 180), "6" = list(angle = 180)))

```

Add a new metadata column with a combined protocol and lung ID label

```{r eval=FALSE}

CLN$protocol_sample <- gsub(pattern = " ", replacement = "_", paste0(CLN$protocol, "_ID: ", CLN$paper_id))
ST.FeaturePlot(CLN, features = "nFeature_RNA", ncol = 3, label.by = "protocol_sample")

```

Add manual annotations

```{r eval=FALSE}

CLN <- ManualAnnotation(CLN)

```

```{r include=FALSE, eval=FALSE}
# Export selections

#saveRDS(CLN@meta.data, file = "../R_objects/CLN_metadata_selections")
CLN@meta.data <- readRDS("../R_objects/CLN_metadata_selections")

```


### Filter out background and serosa
***

```{r eval=FALSE}

CLN <- SubsetSTData(CLN, expression = labels %in% c("mucosa", "submucosa", "muscularis"))

```

### Export annotations
***

```{r fig.width=14, fig.height=4}


infoTable[c(5:6, 2, 4, 1, 3), 1]

limits_list <- list("2" = c(x_start = 260, y_start = 500, x_end = 1600, y_end = 1800),
                    "3" = c(x_start = 170, y_start = 340, x_end = 1400, y_end = 1500),
                    "4" = c(x_start = 130, y_start = 240, x_end = 1780, y_end = 1560),
                    "6" = c(x_start = 300, y_start = 280, x_end = 1820, y_end = 1700))

ann_plots <- lapply(c("2", "3", "4", "6"), function(i) {
  
  gg <- cbind(CLN[[]], GetStaffli(CLN)@meta.data)
  gg <- subset(gg, sample == i)
  dims <- GetStaffli(CLN)@dims[[i]]
  
  p <- ggplot(gg, aes(warped_x, dims$height - warped_y, color = labels)) +
    geom_point(size = 1) +
    theme_void() +
    scale_color_manual(values = c("mucosa" = "#AA4499", "submucosa" = "#DDCC77", "muscularis" = "#CC6677")) +
    scale_x_continuous(expand = c(0, 0), limits = c(limits_list[[i]]["x_start"], 
                                  limits_list[[i]]["x_end"])) +
    scale_y_continuous(expand = c(0, 0), limits = c(dims$height - limits_list[[i]]["y_end"], 
                                  dims$height - limits_list[[i]]["y_start"])) +
    theme(legend.position = "none")

  p <- ggrastr::rasterize(p, layers = "Point", dpi = 300)
  return(p)
})

# HE images
plots_HE <- lapply(c("2", "3", "4", "6"), function(i) {
  im <- GetStaffli(CLN)@rasterlists$processed[[paste0(i)]]
  dims <- GetStaffli(CLN)@dims[[i]]
   
  im <- im[limits_list[[i]]["y_start"]:limits_list[[i]]["y_end"]*0.5, limits_list[[i]]["x_start"]:limits_list[[i]]["x_end"]*0.5]
  g <- grid::rasterGrob(im, width = unit(1, "npc"), height = unit(1, "npc"), interpolate = TRUE)
  p <- ggplot() +
    annotation_custom(g, -Inf, Inf, -Inf, Inf) +
    theme_void() +
    theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0))
  return(p)
})

p1 <- plots_HE[[1]] + 
  ann_plots[[1]]
pdf(file = "sample1_RRST.pdf", width = 6.3, height = 3.05)
print(p1)
dev.off()

p2 <-  plots_HE[[2]] +
  ann_plots[[2]]
pdf(file = "sample1_standard.pdf", width = 5.7, height = 2.9)
print(p2)
dev.off()

p3 <-  plots_HE[[3]] +
  ann_plots[[3]]
pdf(file = "sample2_RRST.pdf", width = 7.8, height = 3.2)
print(p3)
dev.off()

p4 <-  plots_HE[[4]] +
  ann_plots[[4]]
pdf(file = "sample2_standard.pdf", width = 7, height = 3.4)
print(p4)
dev.off()


```


### Plot QC by region
***

```{r fig.width=14, fig.height=5}

th <- theme(panel.background = element_rect(fill = "white", colour = "lightgray"), 
          panel.grid = element_line(colour = "lightgray", linetype = "longdash"), 
          axis.text.x = element_blank(),
          axis.text.y = element_text(size = 14, color = "black"), 
          plot.title = element_text(size = 18, face = "bold"), 
          axis.ticks.x = element_blank(), 
          strip.text = element_text(size = 16, color = "white", face = "bold"),
          legend.text = element_text(size = 14),
          legend.title = element_text(size = 16), legend.position = "bottom") 

dt <- CLN[[]] %>% 
  mutate(protocol = setNames(c("RRST", "standard"), nm = c("RNA rescue", "standard"))[protocol]) %>%
  mutate(labels = factor(setNames(c("Mucosa", "Submucosa", "Muscularis"), 
                                  nm = c("mucosa", "submucosa", "muscularis"))[labels], 
                         levels = c("Mucosa", "Submucosa", "Muscularis")), 
         arrayID = factor(arrayID, levels = c("V11M22-349_A1", "V11M22-349_B1", "V11A20-396_A1",
                                              "V10S29-108_B1", "V11B18-363_C1", "V11A20-396_C1")),
         paper_id = setNames(c("Sample 1", "Sample 2"), nm = c("1.0", "2.0"))[paper_id])

p1 <- ggplot() +
    geom_violin(data = dt, aes(arrayID, nFeature_RNA, fill = protocol), scale = "width") +
    geom_point(data = dt %>% 
                 mutate(replicate = setNames(c("rep1", "rep2", "rep1", "rep1", "rep2", "rep1"), 
                                       nm = c("V11M22-349_A1", "V11M22-349_B1", "V11A20-396_A1",
                                              "V10S29-108_B1", "V11B18-363_C1", "V11A20-396_C1"))[arrayID]) %>%
                 group_by(labels, paper_id, arrayID, replicate) %>% 
                 summarize(Mean = median(nFeature_RNA)), 
               aes(arrayID, Mean, shape = replicate), size = 3) +
    scale_shape_manual(values = c("rep1" = 4, "rep2" = 6)) +
    facet_grid(paper_id~labels, scales = "free", space = "free") +
    labs(y = "", x = "", title = "Unique genes") +
    th +
    scale_y_log10()

p2 <- ggplot() +
    geom_violin(data = dt, aes(arrayID, nCount_RNA, fill = protocol), scale = "width") +
    geom_point(data = dt %>% 
                 mutate(replicate = setNames(c("rep1", "rep2", "rep1", "rep1", "rep2", "rep1"), 
                                       nm = c("V11M22-349_A1", "V11M22-349_B1", "V11A20-396_A1",
                                              "V10S29-108_B1", "V11B18-363_C1", "V11A20-396_C1"))[arrayID]) %>%
                 group_by(labels, paper_id, arrayID, replicate) %>% 
                 summarize(Mean = median(nCount_RNA)), 
               aes(arrayID, Mean, shape = replicate), size = 3) +
    scale_shape_manual(values = c("rep1" = 4, "rep2" = 6)) +
    facet_grid(paper_id~labels, scales = "free") +
    labs(y = "", x = "", title = "UMI counts") +
    th +
    scale_y_log10()

p <- p1 | p2

pdf(file = "QC_by_region.pdf", width = 14*1.2, height = 6*1.2)
print(p)
dev.off()

```

```{r fig.width=12, fig.height=3}

CLN$unique_genes_log10 <- log10(CLN$nFeature_RNA)
CLN$UMIs_log10 <- log10(CLN$nCount_RNA)
CLN$UMIs_log10[CLN$UMIs_log10 < quantile(CLN$UMIs_log10, 0.01)] <- quantile(CLN$UMIs_log10, 0.01)

ann_plots <- lapply(c("2", "3", "4", "6"), function(i) {
  gg <- cbind(CLN[[]], GetStaffli(CLN)@meta.data)
  gg <- subset(gg, sample == i)
  dims <- GetStaffli(CLN)@dims[[i]]
  
  p <- ggplot(gg, aes(warped_x, dims$height - warped_y, color = UMIs_log10)) +
    geom_point(size = 1) +
    theme_void() +
    scale_color_gradientn(colours = RColorBrewer::brewer.pal(n = 11, name = "Spectral") %>% rev(), 
                          breaks = c(2, 3, 4), labels = c(100, 1000, 10000),
                          limits = col_dims) +
    scale_x_continuous(expand = c(0, 0), limits = c(limits_list[[i]]["x_start"], 
                                  limits_list[[i]]["x_end"])) +
    scale_y_continuous(expand = c(0, 0), limits = c(dims$height - limits_list[[i]]["y_end"], 
                                  dims$height - limits_list[[i]]["y_start"])) +
    theme(legend.position = "none")
  
  p <- ggrastr::rasterize(p, layers = "Point", dpi = 300)
  return(p)
})

pdf(file = "sample1_RRST_UMIs_log10.pdf", width = 3.15, height = 3)
print(ann_plots[[1]])
dev.off()

pdf(file = "sample1_standard_UMIs_log10.pdf", width = 2.75, height = 2.7)
print(ann_plots[[2]])
dev.off()

pdf(file = "sample2_RRST_UMIs_log10.pdf", width = 3.9, height = 3)
print(ann_plots[[3]])
dev.off()

pdf(file = "sample2_standard_UMIs_log10.pdf", width = 3.5, height = 3.4)
print(ann_plots[[4]])
dev.off()

```


Filter data

```{r}

umis_standard <- rownames(CLN)[rowSums(GetAssayData(CLN, slot = "counts")[, CLN$protocol == "standard"]) > 0]
umis_RRST <- rownames(CLN)[rowSums(GetAssayData(CLN, slot = "counts")[, CLN$protocol == "RNA rescue"]) > 0]

genes.keep <- intersect(umis_standard, umis_RRST)

```

```{r}

CLN.subset <- SubsetSTData(CLN, features = genes.keep)
library(harmony)
CLN.subset <- CLN.subset %>% 
  NormalizeData() %>% 
  ScaleData() %>% 
  FindVariableFeatures() %>%
  RunPCA() %>%
  RunHarmony(group.by.vars = c("arrayID", "protocol", "paper_id")) %>%
  FindNeighbors(reduction = "harmony", dims = 1:20) %>%
  FindClusters() %>%
  RunUMAP(reduction = "harmony", dims = 1:20)

```


```{r}

DimPlot(CLN.subset)

```


```{r fig.width=8, fig.height=4}

selected.genes <- c("CLDN3", "CLDN4", "CLDN7", "FABP1", "SLC26A2", "SLC26A3", "MS4A12", "SLC26A3", "CEACAM7", "AQP8", "KRT20", "PIGR")
gg <- cbind(CLN.subset[[]], FetchData(CLN.subset, vars = selected.genes)) %>%
  subset(labels == "mucosa") %>%
  reshape2::melt(measure.vars = selected.genes) %>%
  mutate(paper_id = setNames(c("Sample1", "Sample2"), nm = c("1.0", "2.0"))[paper_id],
         protocol = setNames(c("RRST", "standard"), nm = c("RNA rescue", "standard"))[protocol])

ggs <- gg %>% 
  group_by(protocol, paper_id, variable) %>%
  summarize(det = paste0(round(sum(value > 0)/n(), digits = 2)*100, "%"))
  

p <- ggplot() +
  geom_violin(data = gg, aes(protocol, value, fill = protocol), scale = "width") +
  geom_label(data = ggs, aes(protocol, -1, fill = protocol, label = det)) +
  facet_grid(paper_id ~ variable) +
  labs(y = "Normalized expression") +
  theme(axis.text.x = element_blank(), 
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 16, color = "black"),
        strip.text = element_text(size = 14, color = "black", face = "bold"),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 14),
        axis.text.y = element_text(size = 14, color = "black"),
        panel.background = element_rect(fill = "white"),
        panel.grid = element_line(colour = "lightgray", linetype = "longdash"),
        legend.position = "bottom") +
  scale_fill_brewer(palette = "Pastel1")
#p <- ggrastr::rasterize(p, layers = "Point", dpi = 300)

pdf(file = "selected_markers_violin.pdf", width = 18, height = 5.5)
print(p)
dev.off()

```



# date
***

```{r eval=FALSE}
date()
```

# Session
***

```{r eval=FALSE}
devtools::session_info()
```